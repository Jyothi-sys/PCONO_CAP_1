var that;sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV","sap/ui/export/Spreadsheet","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/Token","sap/m/MessageBox","sap/m/BusyDialog","sap/ui/model/Sorter","byplantproposal/utils/formatter","sap/ui/export/library"],function(e,t,a,o,r,i,n,s,l,d,h,p,u,g,c){"use strict";return e.extend("byplantproposal.controller.View1",{customFormatter:g,onInit:function(){that=this;that.filteredData;that.busy=new p;this.onReadCall();this.oFilterBar=this.getView().byId("filterbar");this.oTable=this.getView().byId("exportTable")},onReadCall:function(){var e=this.getOwnerComponent().getModel("byplantproposal_Model");that.busy.open();var t=new sap.ui.model.json.JSONModel;e.callFunction("/userInfo",{success:function(e){t.setData(e.userInfo.scopes);that.getView().setModel(t,"userModel");that.userLoggedIn=e.userInfo.user}.bind(that),error:function(e){}.bind(that)});e.read("//pcona_by_plant_proposal_rules",{success:function(e){var t=that.getView().getModel("userModel").getData();if(t.TISAdmin===true){for(var o=0;o<e.results.length;o++){e.results[o].Days=parseInt(e.results[o].Days)}that.getView().setModel(e.results,"globalMainData");that.tableModelToView=new a(that.getView().getModel("globalMainData"));that.getView().setModel(that.tableModelToView,"tableModel")}else{that.getView().setModel([],"globalMainData")}that.busy.close()},error:function(e){that.busy.close()}})},onOpenIdentifierFragment:function(e){if(this.oIdentifierFrag){this.oIdentifierFrag=undefined}if(!this.oIdentifierFrag){that.busy.open();this.oIdentifierFrag=sap.ui.xmlfragment("byplantproposal.Fragments.Identifier",that);this.getView().addDependent(that.oIdentifierFrag);var t=that.getView().getModel("globalMainData");var o={};var r=t;var i=[];for(var n,s=0;n=r[s++];){var l=n.Identifier;if(!(l in o)){o[l]=1;i.push({Identifier:l})}}var d=new a(i);this.getView().setModel(d,"IdentifierGlobalData");this.oIdentifierFrag.setModel(d,"IdentifierData")}that.busy.close();this.oIdentifierFrag.open()},onSelectionIdentifier:function(e){var t=e.getParameter("selectedContexts");var a=this.getView().byId("id_Identifier");var o=[];var r=that.getView().getModel("IdentifierGlobalData");for(var i=0;i<t.length;i++){o.push(t[i])}var n=[];$.each(o,function(e,t){if($.inArray(t.ProductId,n)===-1)n.push(t.getObject())});r.setProperty("/tokens2",n);var s;s=a.getTokens()[0];if(!s){s=new d({text:"{Identifier}",key:"{Identifier}"})}else{s=a.getTokens()[0].clone()}n.forEach(function(e){a.addToken(new d({text:e.Identifier}))})},onSearchIdentifier:function(e){var t=e.getParameter("value");var a=new n("Identifier",sap.ui.model.FilterOperator.Contains,t);var o=e.getParameter("itemsBinding");o.filter([a])},onOpenCustomerFragment:function(e){if(this.oCustomerFrag){this.oCustomerFrag=undefined}if(!this.oCustomerFrag){that.busy.open();this.oCustomerFrag=sap.ui.xmlfragment("byplantproposal.Fragments.Customer",that);this.getView().addDependent(that.oCustomerFrag);var t=that.getView().getModel("globalMainData");var o={};var r=t;var i=[];for(var n,s=0;n=r[s++];){var l=n.Customer;if(!(l in o)){o[l]=1;i.push({Customer:l})}}var d=new a(i);this.getView().setModel(d,"CustomerGlobalData");this.oCustomerFrag.setModel(d,"CustomerData")}that.busy.close();this.oCustomerFrag.open()},onSelectionCustomer:function(e){var t=e.getParameter("selectedContexts");var a=this.getView().byId("id_Customer");var o=[];var r=this.getView().getModel("CustomerGlobalData");for(var i=0;i<t.length;i++){o.push(t[i])}that.oCustomerModel=[];$.each(o,function(e,t){if($.inArray(t.ProductId,that.oCustomerModel)===-1)that.oCustomerModel.push(t.getObject())});r.setProperty("/tokens1",that.oCustomerModel);var n;n=a.getTokens()[0];if(!n){n=new d({text:"{Customer}",key:"{Customer}"})}else{n=a.getTokens()[0].clone()}that.oCustomerModel.forEach(function(e){a.addToken(new d({text:e.Customer}))})},onSearchCustomer:function(e){var t=e.getParameter("value");var a=new n("Customer",sap.ui.model.FilterOperator.Contains,t);var o=e.getParameter("itemsBinding");o.filter([a])},onOpenGroupFragment:function(e){if(this.oGroupFrag){this.oGroupFrag=undefined}if(!this.oGroupFrag){that.busy.open();this.oGroupFrag=sap.ui.xmlfragment("byplantproposal.Fragments.Group",that);this.getView().addDependent(that.oGroupFrag);var t=that.getView().getModel("globalMainData");var o={};var r=t;var i=[];for(var n,s=0;n=r[s++];){var l=n.Group;if(!(l in o)){o[l]=1;i.push({Group:l})}}var d=new a(i);this.getView().setModel(d,"GroupGlobalData");this.oGroupFrag.setModel(d,"GroupData")}that.busy.close();this.oGroupFrag.open()},onSelectionGroup:function(e){this.getView().byId("id_Group").setTokens([]);that.oGroupSelectedModel=[];var t=e.getParameter("selectedContexts");var a=this.getView().byId("id_Group");var o=[];var r=this.getView().getModel("GroupGlobalData");for(var i=0;i<t.length;i++){o.push(t[i])}that.oGroupSelectedModel=[];$.each(o,function(e,t){if($.inArray(t.ProductId,that.oGroupSelectedModel)===-1)that.oGroupSelectedModel.push(t.getObject())});r.setProperty("/tokens3",that.oGroupSelectedModel);var n;n=a.getTokens()[0];if(!n){n=new d({text:"{Group}",key:"{Group}"})}else{n=a.getTokens()[0].clone()}that.oGroupSelectedModel.forEach(function(e){a.addToken(new d({text:e.Group}))})},onOpenShipPlantFragment:function(e){if(this.oShipPlantFrag){this.oShipPlantFrag=undefined}if(!this.oShipPlantFrag){that.busy.open();this.oShipPlantFrag=sap.ui.xmlfragment("byplantproposal.Fragments.ShipPlant",that);this.getView().addDependent(that.oShipPlantFrag);var t=that.getView().getModel("globalMainData");var o={};var r=t;var i=[];for(var n,s=0;n=r[s++];){var l=n.ShipPlant;if(!(l in o)){o[l]=1;i.push({ShipPlant:l})}}var d=new a(i);this.getView().setModel(d,"ShipPlant_GlobalData");this.oShipPlantFrag.setModel(d,"ShipPlantData")}that.busy.close();this.oShipPlantFrag.open()},onSelectionShipPlant:function(e){var t=e.getParameter("selectedContexts");var a=this.getView().byId("id_ShipPlant");var o=[];var r=this.getView().getModel("ShipPlant_GlobalData");for(var i=0;i<t.length;i++){o.push(t[i])}var n=[];$.each(o,function(e,t){if($.inArray(t.ProductId,n)===-1)n.push(t.getObject())});r.setProperty("/tokens4",n);var s;s=a.getTokens()[0];if(!s){s=new d({text:"{ShipPlant}",key:"{ShipPlant}"})}else{s=a.getTokens()[0].clone()}n.forEach(function(e){a.addToken(new d({text:e.ShipPlant}))})},onSearchShipPlant:function(e){var t=e.getParameter("value");var a=new n("ShipPlant",sap.ui.model.FilterOperator.Contains,t);var o=e.getParameter("itemsBinding");o.filter([a])},onOpenDaysFragment:function(e){if(this.oDaysFrag){this.oDaysFrag=undefined}if(!this.oDaysFrag){that.busy.open();this.oDaysFrag=sap.ui.xmlfragment("byplantproposal.Fragments.Days",that);this.getView().addDependent(that.oDaysFrag);var t=that.getView().getModel("globalMainData");var o={};var r=t;var i=[];for(var n,s=0;n=r[s++];){var l=n.Days;if(!(l in o)){o[l]=1;i.push({Days:l})}}var d=new a(i);this.getView().setModel(d,"Days_GlobalData");this.oDaysFrag.setModel(d,"DaysData")}that.busy.close();this.oDaysFrag.open()},onSelectionDays:function(e){var t=e.getParameter("selectedContexts");var a=this.getView().byId("id_Days");var o=[];var r=this.getView().getModel("Days_GlobalData");for(var i=0;i<t.length;i++){o.push(t[i])}var n=[];$.each(o,function(e,t){if($.inArray(t.ProductId,n)===-1)n.push(t.getObject())});r.setProperty("/tokens4",n);var s;s=a.getTokens()[0];if(!s){s=new d({text:"{Days}",key:"{Days}"})}else{s=a.getTokens()[0].clone()}n.forEach(function(e){a.addToken(new d({text:e.Days}))})},onSearchDays:function(e){var t=e.getParameter("value");var a=new n("Days",sap.ui.model.FilterOperator.Contains,t);var o=e.getParameter("itemsBinding");o.filter([a])},onSearchGroup:function(e){var t=e.getParameter("value");var a=new n("Group",sap.ui.model.FilterOperator.Contains,t);var o=e.getParameter("itemsBinding");o.filter([a])},onDialogClose:function(e){this.onCancelUpload();if(this.oShipPlantFrag){this.oShipPlantFrag=undefined;this.oShipPlantFrag=null}if(this.oDaysFrag){this.oDaysFrag=undefined;this.oDaysFrag=null}if(this.oMaterialFrag){this.oMaterialFrag=undefined;this.oMaterialFrag=null}if(this.oGroupFrag){this.oGroupFrag=undefined}if(this.oComapnyCodeFrag){this.oComapnyCodeFrag=undefined;this.oComapnyCodeFrag=null}if(that.oEditTableRowFrag){that.oEditTableRowFrag.close();that.oEditTableRowFrag=undefined;that.oEditTableRowFrag=null;var t=new a;this.getView().setModel(t,"curSelTableRow")}if(that.oCreatePlantProposalFrag){that.oCreatePlantProposalFrag.close();that.oCreatePlantProposalFrag=undefined;that.oCreatePlantProposalFrag=null;var t=new a;this.getView().setModel(t,"createTableRow")}},onGoToReport:function(){that.busy.open();var e=this.getView().byId("id_Identifier").getTokens();that.sIdentifierValues=e.map(function(e){return e.getText()}).join(",");var t=this.getView().byId("id_Customer").getTokens();that.sCustomerValues=t.map(function(e){return e.getText()}).join(",");var o=this.getView().byId("id_Group").getTokens();that.sGroupValues=o.map(function(e){return e.getText()}).join(",");var r=this.getView().byId("id_ShipPlant").getTokens();that.sShipPlantValues=r.map(function(e){return e.getText()}).join(",");var i=this.getView().byId("id_Days").getTokens();that.sDaysValues=i.map(function(e){return e.getText()}).join(",");var n=[];if(that.sIdentifierValues!==""){var s=that.sIdentifierValues.split(",");if(s.length>0){$.each(s,function(e,t){n.push(new sap.ui.model.Filter("Identifier",sap.ui.model.FilterOperator.Contains,t))})}}if(that.sCustomerValues!==""){var l=that.sCustomerValues.split(",");if(l.length>0){$.each(l,function(e,t){n.push(new sap.ui.model.Filter("Customer",sap.ui.model.FilterOperator.Contains,t))})}}if(that.sGroupValues!==""){var d=that.sGroupValues.split(",");if(d.length>0){$.each(d,function(e,t){n.push(new sap.ui.model.Filter("Group",sap.ui.model.FilterOperator.Contains,t))})}}if(that.sShipPlantValues!==""){var h=that.sShipPlantValues.split(",");if(h.length>0){$.each(h,function(e,t){n.push(new sap.ui.model.Filter("ShipPlant",sap.ui.model.FilterOperator.Contains,t))})}}if(that.sDaysValues!==""){var p=that.sDaysValues.split(",");if(p.length>0){$.each(p,function(e,t){n.push(new sap.ui.model.Filter("Days",sap.ui.model.FilterOperator.EQ,t))})}}that.tableMainModelfiltereddata=undefined;that.tableMainModelfiltereddata=new a(that.getView().getModel("globalMainData"));that.getView().setModel(that.tableMainModelfiltereddata,"tableModel");this.getView().byId("exportTable").getBinding("items").filter(n);that.filteredData=true;that.filteredDataToExport=[];var u=this.getView().byId("exportTable").getBinding("items").aIndices.length;that.filteredIndices=this.getView().byId("exportTable").getBinding("items").aIndices;for(var g=0;g<u;g++){that.filteredDataToExport.push(that.tableMainModelfiltereddata.oData[that.filteredIndices[g]])}var c=new a(that.filteredDataToExport);that.getView().setModel(c,"tableModel");that.busy.close()},onPressClear:function(e){that.filteredData=false;this.getView().byId("id_Customer").setTokens([]);this.getView().byId("id_Identifier").setTokens([]);this.getView().byId("id_Group").setTokens([]);this.getView().byId("id_ShipPlant").setTokens([]);this.getView().byId("id_Days").setTokens([]);var t=new a;that.getView().setModel(t,"tableModel")},attachDateToExcel:function(){var e=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"MM-dd-yyyy"});var t=e.format(new Date);return t},onExportSelected:function(e){this.onGoToReport();var t=this.getView().byId("exportTable").getSelectedItems().length;var a=this.getView().byId("exportTable").getSelectedItem();var o=this.getView().getModel("globalMainData");var r;if(that.filteredData===true){r=new sap.ui.model.json.JSONModel(that.getView().getModel("tableModel").oData)}else{r=new sap.ui.model.json.JSONModel(that.selectedEntries.getData())}var i=[{label:"Rule_ID_TVARVC",property:"Identifier"},{label:"Customer",property:"Customer"},{label:"Del_Group",property:"Group"},{label:"ShipPlant",property:"ShipPlant"},{label:"Days",property:"Days"},{label:"Created_By",property:"created_by"},{label:"Created_On",property:"created_on"},{label:"Changed_By",property:"changed_by"},{label:"Changed_On",property:"changed_on"}];var n={workbook:{columns:i,context:{sheetName:"byplantproposal_"+this.attachDateToExcel()}},dataSource:r.getData(),fileName:"byplantproposal_"+this.attachDateToExcel()+".xlsx"};var s=new sap.ui.export.Spreadsheet(n);s.build().then(function(){s.destroy()})},handleSortButtonPressed:function(e){if(this.oSortFrag){this.oSortFrag=undefined}if(!this.oSortFrag){that.busy.open();this.oSortFrag=sap.ui.xmlfragment("byplantproposal.Fragments.ascAndDscSort",that);this.getView().addDependent(that.oSortFrag)}that.busy.close();this.oSortFrag.open()},handleSortDialogConfirm:function(e){var t=this.byId("exportTable"),a=e.getParameters(),o=t.getBinding("items"),r,i,n=[];r=a.sortItem.getKey();i=a.sortDescending;n.push(new u(r,i));o.sort(n)},onOpenCreatePlantProposalFragment:function(e){if(this.oCreatePlantProposalFrag){this.oCreatePlantProposalFrag=undefined}if(!this.oCreatePlantProposalFrag){that.busy.open();this.oCreatePlantProposalFrag=sap.ui.xmlfragment("byplantproposal.Fragments.createPlantProposal",that);this.getView().addDependent(that.oCreatePlantProposalFrag);var t={Customer:"",Identifier:"",Group:"",ShipPlant:"",Days:""};var o=new a(t);this.getView().setModel(o,"createTableRow")}that.busy.close();this.oCreatePlantProposalFrag.open()},onCreateSave:function(){var e=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var t=e.format(new Date);var a=this.getOwnerComponent().getModel("byplantproposal_Model");a.callFunction("/byplant_create",{method:"GET",urlParameters:{Identifier:that.getView().getModel("createTableRow").oData.Identifier,Customer:that.getView().getModel("createTableRow").oData.Customer,Group:that.getView().getModel("createTableRow").oData.Group,ShipPlant:that.getView().getModel("createTableRow").oData.ShipPlant,Days:that.getView().getModel("createTableRow").oData.Days},success:function(e){that.onReadCall();that.onDialogClose()}.bind(this),error:function(e){h.error(JSON.parse(e.responseText).error.message.value)}})},onCreateSave_copy:function(){var e=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var t=e.format(new Date);var a=this.getOwnerComponent().getModel("byplantproposal_Model");a.callFunction("/byplant_create",{method:"GET",urlParameters:{Identifier:that.getView().getModel("curSelTableRow").oData.Identifier,Customer:that.getView().getModel("curSelTableRow").oData.Customer,Group:that.getView().getModel("curSelTableRow").oData.Group,ShipPlant:that.getView().getModel("curSelTableRow").oData.ShipPlant,Days:that.getView().getModel("curSelTableRow").oData.Days},success:function(e){that.onReadCall();that.onDialogClose()}.bind(this),error:function(e){h.error(JSON.parse(e.responseText).error.message.value)}})},onselectionChange:function(e){var t=this.getView().byId("exportTable").getSelectedItems().length;if(t>1){this.getView().byId("editModeButton").setEnabled(false)}else if(t==1){this.getView().byId("editModeButton").setEnabled(true)}var o=this.getView().byId("exportTable").getSelectedItem();if(o){var r=new a(o.getBindingContext("tableModel").getObject());this.getView().setModel(r,"curSelTableRow")}},onCreateTableRow:function(e){if(this.getView().byId("exportTable").getSelectedItems().length<1){this.onOpenCreatePlantProposalFragment()}else{if(this.oEditTableRowFrag){this.oEditTableRowFrag=undefined}if(!this.oEditTableRowFrag){that.busy.open();var t=e.getSource().getParent().getParent().getSelectedContextPaths();if(t.length!==0){var o=this.getView().getModel("tableModel").getProperty(t[0]);var r={Identifier:o.Identifier,Customer:o.Customer,Group:o.Group,ShipPlant:o.ShipPlant,Days:o.Days};var i=new a(r);this.getView().setModel(i,"curSelTableRow");this.oEditTableRowFrag=sap.ui.xmlfragment("byplantproposal.Fragments.createPlantProposalCopy",that);this.getView().addDependent(that.oEditTableRowFrag)}that.busy.close();this.oEditTableRowFrag.open()}}},onEditTableRow:function(e){if(this.getView().byId("exportTable").getSelectedItems().length<1){h.warning("Please select line item to edit")}else{if(this.oEditTableRowFrag){this.oEditTableRowFrag=undefined}if(!this.oEditTableRowFrag){that.busy.open();var t=e.getSource().getParent().getParent().getSelectedContextPaths();if(t.length!==0){var o=this.getView().getModel("tableModel").getProperty(t[0]);var r={Identifier:o.Identifier,Customer:o.Customer,Group:o.Group,ShipPlant:o.ShipPlant,Days:o.Days};var i=new a(r);this.getView().setModel(i,"curSelTableRow");this.oEditTableRowFrag=sap.ui.xmlfragment("byplantproposal.Fragments.editTableRow",that);this.getView().addDependent(that.oEditTableRowFrag)}that.busy.close();this.oEditTableRowFrag.open()}}},onSaveEdit:function(){var e=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var t=e.format(new Date);var a=this.getOwnerComponent().getModel("byplantproposal_Model");a.callFunction("/byplant_create",{method:"GET",urlParameters:{Identifier:that.getView().getModel("curSelTableRow").oData.Identifier,Customer:that.getView().getModel("curSelTableRow").oData.Customer,Group:that.getView().getModel("curSelTableRow").oData.Group,ShipPlant:that.getView().getModel("curSelTableRow").oData.ShipPlant,Days:that.getView().getModel("curSelTableRow").oData.Days},success:function(e){that.onReadCall();that.onDialogClose()}.bind(this),error:function(e){h.error(JSON.parse(e.responseText).error.message.value)}})},onDelete:function(){if(this.getView().byId("exportTable").getSelectedItems().length<1){h.warning("Please select line item to delete")}else{var e=this.getOwnerComponent().getModel("byplantproposal_Model");this._oTable=this.getView().byId("exportTable");var t=this._oTable.getModel("tableModel").getData();var a=this._oTable.getSelectedContexts();var o=this._oTable.getModel("tableModel");var r=e.getDeferredGroups();if(r.indexOf("delete")===-1){r.push("delete")}e.setDeferredGroups(r);for(var i=0;i<a.length;i++){var n=a[i].getObject();var s=$.map(t,function(t,a){if(t===n){e.callFunction("/byplant_delete",{method:"GET",urlParameters:{Identifier:n.Identifier,Customer:n.Customer,Group:n.Group,ShipPlant:n.ShipPlant,Days:n.Days},groupId:"delete"});return a}})}e.submitChanges({groupId:"delete",success:function(e){that.onReadCall()}.bind(this),error:function(e){}})}},onSelectFile:function(e){this._import(e.getParameter("files")&&e.getParameter("files")[0])},_import:function(e){var t=this.getOwnerComponent().getModel("uploadModel");t.setData({aPlantProp:[]});var a=this;var o=[];var r=[];if(e&&window.FileReader){var i=new FileReader;i.onload=function(e){var t=e.target.result;var i=XLSX.read(t,{type:"binary"});i.SheetNames.forEach(function(e){o=XLSX.utils.sheet_to_row_object_array(i.Sheets[e]);r=XLSX.utils.sheet_to_row_object_array(i.Sheets[e])});a.getOwnerComponent().getModel("uploadModel").getData().aPlantProp=o;a.getOwnerComponent().getModel("uploadModel").refresh(true);h.warning("Do you want to upload file?",{icon:h.Icon.WARNING,title:"Confirm...!",actions:[h.Action.OK,h.Action.CANCEL],emphasizedAction:h.Action.OK,onClose:function(e){if(e===h.Action.OK){a.uploadFile()}else if(e===h.Action.CANCEL){}}})};i.onerror=function(e){};i.readAsBinaryString(e)}},uploadFile:function(){var e=this.getOwnerComponent().getModel("uploadModel").getData().aPlantProp;for(var t=0;t<e.length;t++){var a=this.getOwnerComponent().getModel("byplantproposal_Model");a.callFunction("/byplant_create",{method:"GET",async:false,urlParameters:{Identifier:e[t].Rule_ID_TVARVC?e[t].Rule_ID_TVARVC:"",Customer:e[t].Customer?e[t].Customer:"",Group:e[t].Del_Group?e[t].Del_Group:"",ShipPlant:e[t].ShipPlant,Days:e[t].Days}},this)}a.submitChanges({success:function(e){h.success("Data Uploaded Successfully...",{icon:h.Icon.SUCCESS,title:"Upload Successful...",actions:[h.Action.OK],emphasizedAction:h.Action.OK,onClose:function(e){if(e===h.Action.OK){that.onReadCall()}}})}.bind(this),error:function(e){h.error(JSON.parse(e.responseText).error.message.value)}});this.onCancelUpload();that.onDialogClose()},onUploadFileDialog:function(e){this.onCancelUpload();var t=this;if(this.oComapnyCodeFrag){this.oComapnyCodeFrag=undefined;this.oComapnyCodeFrag=null}if(!this.oComapnyCodeFrag){this.oComapnyCodeFrag=sap.ui.xmlfragment("byplantproposal.Fragments.uploadDialog",t);this.getView().addDependent(t.oComapnyCodeFrag)}this.oComapnyCodeFrag.open()},onCancelUpload:function(e){if(this.oComapnyCodeFrag){this.oComapnyCodeFrag.close();this.oComapnyCodeFrag.destroy();this.oComapnyCodeFrag=undefined;this.oComapnyCodeFrag=null}}})});