var that;sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/Token","sap/ui/core/date/UI5Date","sap/m/MessageBox","sap/m/BusyDialog","sap/ui/model/Sorter","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV","sap/ui/export/Spreadsheet"],function(e,t,a,r,i,s,n,o,l,d,h,u,g,p){"use strict";return e.extend("pivs.controller.View1",{onInit:function(){that=this;that.filteredData;that.busy=new d;this.setMaxDateforDateRange();this.pivsReadCall();this.oFilterBar=this.getView().byId("filterbar");this.oTable=this.getView().byId("PIVSTable")},pivsReadCall:function(){var e=this.getOwnerComponent().getModel("SalesSrv_global_model");that.busy.open();var t=new sap.ui.model.json.JSONModel;e.callFunction("/userInfo",{success:function(e){t.setData(e.userInfo.scopes);that.getView().setModel(t,"userModel");that.userLoggedIn=e.userInfo.user}.bind(that),error:function(e){}.bind(that)});e.read("/pivs_records",{success:function(e){var t=that.getView().getModel("userModel").getData();if(t.TISAdmin===true){that.getView().setModel(e.results,"globalMainData")}else{that.getView().setModel([],"globalMainData")}that.busy.close()},error:function(e){that.busy.close()}})},setMaxDateforDateRange:function(e){var t=new Date;var a=t.setDate(t.getDate());a=new Date(a).getDate();a=a.toString().padStart(2,"0");var r=t.getMonth()+1;r=r.toString().padStart(2,"0");var i=t.getFullYear().toString();that.completeDate=r+"-"+a+"-"+i;const s=new Date(i,r-1,a);var n=this.getView().byId("id_datePicker1");n.setMaxDate(s)},handleChangeDate:function(e){that.startDate=e.mParameters.value.substr(0,10);that.endDate=e.mParameters.value.substr(13,20)},onOpenPlantFragment:function(e){if(this.oPlantFrag){this.oPlantFrag=undefined}if(!this.oPlantFrag){that.busy.open();this.oPlantFrag=sap.ui.xmlfragment("pivs.Fragments.plant",this);this.getView().addDependent(that.oPlantFrag);var t=that.getView().getModel("globalMainData");var r={};var i=t;var s=[];for(var n,o=0;n=i[o++];){var l=n.plant;if(!(l in r)){r[l]=1;s.push({plant:l})}}var d=new a(s);this.getView().setModel(d,"plantGlobalData");this.oPlantFrag.setModel(d,"plantData")}that.busy.close();this.oPlantFrag.open()},onSelectionPlant:function(e){var t=e.getParameter("selectedContexts");var a=this.getView().byId("id_Plant");var r=[];var i=that.getView().getModel("plantGlobalData");for(var s=0;s<t.length;s++){r.push(t[s])}var o=[];$.each(r,function(e,t){if($.inArray(t.ProductId,o)===-1)o.push(t.getObject())});i.setProperty("/tokens2",o);var l;l=a.getTokens()[0];if(!l){l=new n({text:"{plant}",key:"{plant}"})}else{l=a.getTokens()[0].clone()}o.forEach(function(e){a.addToken(new n({text:e.plant}))})},onOpenMaterialFragment:function(e){if(this.oMaterialFrag){this.oMaterialFrag=undefined}if(!this.oMaterialFrag){that.busy.open();this.oMaterialFrag=sap.ui.xmlfragment("pivs.Fragments.material",that);this.getView().addDependent(that.oMaterialFrag);var t=that.getView().getModel("globalMainData");var r={};var i=t;var s=[];for(var n,o=0;n=i[o++];){var l=n.material;if(!(l in r)){r[l]=1;s.push({material:l})}}var d=new a(s);this.getView().setModel(d,"materialGlobalData");this.oMaterialFrag.setModel(d,"materialData")}that.busy.close();this.oMaterialFrag.open()},handleChangeStatus:function(e){var t=e.getSource();that.statusKey=t.getSelectedKey();var a=t._getSelectedItemText()},handleChangeIndicator:function(e){var t=e.getSource();that.indicatorKey=t.getSelectedKey();var a=t._getSelectedItemText()},onSelectionMaterial:function(e){this.getView().byId("id_Material").setTokens([]);that.oMaterialModel=[];var t=e.getParameter("selectedContexts");var a=this.getView().byId("id_Material");var r=[];var i=this.getView().getModel("materialGlobalData");for(var s=0;s<t.length;s++){r.push(t[s])}that.oMaterialModel=[];$.each(r,function(e,t){if($.inArray(t.ProductId,that.oMaterialModel)===-1)that.oMaterialModel.push(t.getObject())});i.setProperty("/tokens3",that.oMaterialModel);var o;o=a.getTokens()[0];if(!o){o=new n({text:"{material}",key:"{material}"})}else{o=a.getTokens()[0].clone()}that.oMaterialModel.forEach(function(e){a.addToken(new n({text:e.material}))})},onOpenSalesOrderFragment:function(e){if(this.oSalesOrderFrag){this.oSalesOrderFrag=undefined}if(!this.oSalesOrderFrag){that.busy.open();this.oSalesOrderFrag=sap.ui.xmlfragment("pivs.Fragments.salesOrder",that);this.getView().addDependent(that.oSalesOrderFrag);var t=that.getView().getModel("globalMainData");var r={};var i=t;var s=[];for(var n,o=0;n=i[o++];){var l=n.salesOrder;if(!(l in r)){r[l]=1;s.push({salesOrder:l})}}var d=new a(s);this.getView().setModel(d,"salesOrderGlobalData");this.oSalesOrderFrag.setModel(d,"salesOrderData")}that.busy.close();this.oSalesOrderFrag.open()},onSelectionSalesOrder:function(e){var t=e.getParameter("selectedContexts");var a=this.getView().byId("id_SalesOrder");var r=[];var i=this.getView().getModel("salesOrderGlobalData");for(var s=0;s<t.length;s++){r.push(t[s])}var o=[];$.each(r,function(e,t){if($.inArray(t.ProductId,o)===-1)o.push(t.getObject())});i.setProperty("/tokens4",o);var l;l=a.getTokens()[0];if(!l){l=new n({text:"{salesOrder}",key:"{salesOrder}"})}else{l=a.getTokens()[0].clone()}o.forEach(function(e){a.addToken(new n({text:e.salesOrder}))})},onSearchPlant:function(e){var t=e.getParameter("value");var a=new r("plant",sap.ui.model.FilterOperator.Contains,t);var i=e.getParameter("itemsBinding");i.filter([a])},onSearchMaterial:function(e){var t=e.getParameter("value");var a=new r("material",sap.ui.model.FilterOperator.Contains,t);var i=e.getParameter("itemsBinding");i.filter([a])},onSearchSalesOrder:function(e){var t=e.getParameter("value");var a=new r("salesOrder",sap.ui.model.FilterOperator.Contains,t);var i=e.getParameter("itemsBinding");i.filter([a])},onDialogClose:function(e){if(this.oSalesOrderFrag){this.oSalesOrderFrag=undefined;this.oSalesOrderFrag=null}else if(this.oMaterialFrag){this.oMaterialFrag=undefined;this.oMaterialFrag=null}else if(this.oPlantFrag){this.oPlantFrag=undefined}},onGoToReport:function(){that.busy.open();var e=this.getView().byId("id_Plant").getTokens();that.sPlantValues=e.map(function(e){return e.getText()}).join(",");var t=this.getView().byId("id_Material").getTokens();that.sMaterialValues=t.map(function(e){return e.getText()}).join(",");var r=this.getView().byId("id_SalesOrder").getTokens();that.sSalesOrderValues=r.map(function(e){return e.getText()}).join(",");var i=[];if(that.startDate===""&&that.endDate===""||that.startDate===undefined&&that.endDate===undefined){l.warning("Please Select Mandatory Fields");that.busy.close()}else{if(that.sMaterialValues!==""){var s=that.sMaterialValues.split(",");if(s.length>0){$.each(s,function(e,t){i.push(new sap.ui.model.Filter("material",sap.ui.model.FilterOperator.Contains,t))})}}if(that.sSalesOrderValues!==""){var n=that.sSalesOrderValues.split(",");if(n.length>0){$.each(n,function(e,t){i.push(new sap.ui.model.Filter("salesOrder",sap.ui.model.FilterOperator.Contains,t))})}}if(that.sPlantValues!==""){var o=that.sPlantValues.split(",");if(o.length>0){$.each(o,function(e,t){i.push(new sap.ui.model.Filter("plant",sap.ui.model.FilterOperator.Contains,t))})}}if(that.startDate!==""&&that.endDate!==""||that.startDate!==undefined&&that.endDate!==undefined){var d=that.startDate;var h=that.endDate;if(d){i.push(new sap.ui.model.Filter("transmissionDate",sap.ui.model.FilterOperator.BT,d,h))}}if(that.statusKey!==""&&that.statusKey!==undefined){var u=that.statusKey;if(u){i.push(new sap.ui.model.Filter("status",sap.ui.model.FilterOperator.Contains,u))}}if(that.indicatorKey!==""&&that.indicatorKey!==undefined){var g=that.indicatorKey;if(g){i.push(new sap.ui.model.Filter("indicator",sap.ui.model.FilterOperator.Contains,g))}}that.tableMainModelfiltereddata=undefined;that.tableMainModelfiltereddata=new a(that.getView().getModel("globalMainData"));that.getView().setModel(that.tableMainModelfiltereddata,"tableModel");this.getDefaultFilteredDateData();this.getView().byId("PIVSTable").getBinding("items").filter(i);that.filteredData=true;that.filteredDataToExport=[];var p=this.getView().byId("PIVSTable").getBinding("items").aIndices.length;that.filteredIndices=this.getView().byId("PIVSTable").getBinding("items").aIndices;for(var f=0;f<p;f++){that.filteredDataToExport.push(that.tableMainModelfiltereddata.oData[that.filteredIndices[f]])}var c=new a(that.filteredDataToExport);that.getView().setModel(c,"tableModel");that.busy.close()}},attachDateToExcel:function(){var e=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"MM-dd-yyyy"});var t=e.format(new Date);return t},onExportSelected:function(e){this.onGoToReport();var t=this.getView().byId("PIVSTable").getSelectedItems();var a=this.getView().getModel("globalMainData");var r=this.filteredData;var i;if(r===true){i=new sap.ui.model.json.JSONModel(this.getView().getModel("tableModel").getData())}else{i=new sap.ui.model.json.JSONModel(a.getData())}var s=[{label:"Indicator",property:"indicator"},{label:"Transmission Date",property:"transmissionDate"},{label:"Timestamp",property:"timestamp"},{label:"Sales Order",property:"salesOrder"},{label:"Scheduled Line No",property:"scheduledLineNo"},{label:"Material",property:"material"},{label:"Plant",property:"plant"},{label:"Confirm Quantity",property:"confirmQuantity"},{label:"Factory Confirm Quantity",property:"factoryConfirmQuantity"},{label:"UOM",property:"uom"},{label:"Confirm Date",property:"confirmDate"},{label:"Status",property:"status"},{label:"Message",property:"message"}];var n={workbook:{columns:s,context:{sheetName:"PIVSExport_"+this.attachDateToExcel()}},dataSource:i.getData(),fileName:"PIVSExport_"+this.attachDateToExcel()+".xlsx"};var o=new sap.ui.export.Spreadsheet(n);o.build().finally(function(){o.destroy()})},handleSortButtonPressed:function(e){if(this.oSortFrag){this.oSortFrag=undefined}if(!this.oSortFrag){that.busy.open();this.oSortFrag=sap.ui.xmlfragment("pivs.Fragments.ascAndDscSort",that);this.getView().addDependent(that.oSortFrag)}that.busy.close();this.oSortFrag.open()},getDefaultFilteredDateData:function(){var e=this.byId("PIVSTable");var t=e.getBinding("items");var a=[];a.push(new h("transmissionDate",true));t.sort(a)},handleSortDialogConfirm:function(e){var t=this.byId("PIVSTable"),a=e.getParameters(),r=t.getBinding("items"),i,s,n=[];i=a.sortItem.getKey();s=a.sortDescending;n.push(new h(i,s));r.sort(n)},onPressClear:function(e){that.filteredData=false;this.getView().byId("id_datePicker1").setValue("");this.getView().byId("id_Plant").setTokens([]);this.getView().byId("id_Material").setTokens([]);this.getView().byId("id_SalesOrder").setTokens([]);this.getView().byId("id_PIVSStatus").setSelectedKey();this.getView().byId("id_Indicator").setSelectedKey();var t=new a;that.getView().setModel(t,"tableModel");that.completeDate="";that.statusKey="";that.indicatorKey="";that.startDate="";that.endDate=""}})});